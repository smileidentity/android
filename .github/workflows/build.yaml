name: Lint, Build, and Test
on:
  pull_request:
  push:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Lints code, builds all modules, runs tests, assembles AAR and APK, and publishes Snapshot
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
      - name: Write Smile Config
        run: |
          echo "$SMILE_CONFIG" > sample/src/main/assets/smile_config.json
        env:
          SMILE_CONFIG: ${{ secrets.SMILE_CONFIG_PARTNER_2423 }}
      - name: Calculate Snapshot Version
        id: version
        # Read version number from the VERSION file and append -SNAPSHOT if not already present
        run: |
          VERSION=$(cat ./lib/VERSION)
          if [[ $VERSION == *"-SNAPSHOT" ]]; then
            echo "Version $VERSION already contains -SNAPSHOT"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "Version $VERSION does not contain -SNAPSHOT"
            echo "version=$VERSION-SNAPSHOT" >> $GITHUB_OUTPUT
          fi
      - name: Build, Test, Lint, Assemble, Publish Snapshot
        uses: gradle/gradle-build-action@v2
        with:
          # NB! The "lint" gradle action here is different than ktLint
          arguments: lint build assembleDebug publish
        env:
          ORG_GRADLE_PROJECT_VERSION_NAME: ${{ steps.version.outputs.version }}
          ORG_GRADLE_PROJECT_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.ARTIFACT_GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.ARTIFACT_GPG_SIGNING_KEY_ID }}
      - name: Archive SDK AAR
        uses: actions/upload-artifact@v3
        with:
          name: SDK AAR
          path: lib/build/outputs/aar/lib-debug.aar
      - name: Archive Sample App
        uses: actions/upload-artifact@v3
        with:
          name: Sample App APK (Partner 002)
          path: sample/build/outputs/apk/debug/sample-debug.apk

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - uses: actions/checkout@v3
      - uses: musichin/ktlint-check@v2
        with:
          ktlint-version: "0.48.2"
